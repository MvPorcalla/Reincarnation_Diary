// story.js
import { getRandomEnemy } from './enemy.js';
import { createScene, recoverHealth } from './utils.js';

export const story = {
  currentScene: 'start',

  scenes: {
    start: createScene({
      id: 'start',
      text: "You wake up in a dark forest. What do you do?",
      choices: [
        { text: "Walk forward", nextScene: 'walkForwardEncounter' },
        { text: "Rest", nextScene: 'rest' },
      ],
      onEnter(player) {
        player.reset();
      }
    }),

    rest: createScene({
      text: "You take a moment to rest.",
      choices: [],
      onEnter(player, params) {
        const chance = Math.random();
        if (chance < 0.5) {
          recoverHealth(player, 10);
          this.text = "You recover 10 health. What next?";
          this.choices = [{ text: "Continue walking", nextScene: 'walkForwardEncounter' }];
        } else {
          this.text = "As you rest, an enemy approaches!";
          this.choices = [{ text: "Prepare to fight", nextScene: 'randomEncounterFight', params: { tier: 2 } }];
        }
      }
    }),

   // continue story...... 
  },

  getScene(sceneName) {
    return this.scenes[sceneName] || this.scenes['gameOver'];
  },

  async setScene(sceneName, player, params = {}) {
    this.currentScene = sceneName;
    const scene = this.getScene(sceneName);
    if (scene?.onEnter) {
      await scene.onEnter(player, params);
    }
  },

  updateScene(sceneName, updates) {
    const scene = this.getScene(sceneName);
    if (scene) {
      Object.assign(scene, updates);
    }
  }
};

export async function onChoiceSelected(choice, player) {
  console.log('Choice selected:', choice);
  if (choice.redirectTo) {
    window.location.href = choice.redirectTo;
    return;
  }
  if (choice.params) {
    await story.setScene(choice.nextScene, player, choice.params);
  } else if (choice.nextScene) {
    await story.setScene(choice.nextScene, player);
  }
}


